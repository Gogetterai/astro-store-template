---
/** ProductCard.astro
 * Safe to drop-in: keeps your existing props (title, blurb, price, buy_url, commission_pct)
 * Adds: slug, image_url, badge, rating, rating_count
 */
const { product } = Astro.props;

const {
  title,
  blurb,
  price,
  commission_pct,
  buy_url,
  slug = '',
  image_url = '/public/assets/placeholder.png',
  badge = '',
  rating = 4.8,
  rating_count = 120
} = product;

const detailsHref = slug ? `/product/${slug}` : '#';
---

<article class="card" itemscope itemtype="https://schema.org/Product">
  <a href={detailsHref} class="thumb" aria-label={`View details for ${title}`}>
    <img src={image_url} alt={`${title} course cover`} loading="lazy" decoding="async" />
    {badge && <span class="badge">{badge}</span>}
  </a>

  <div class="card-body">
    <h3 class="title" itemprop="name">{title}</h3>
    <p class="blurb" itemprop="description">{blurb}</p>

    <div class="meta">
      <div class="price" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
        <meta itemprop="priceCurrency" content="USD" />
        <strong>
          $<span itemprop="price">{price}</span>
        </strong>
        <link itemprop="availability" href="https://schema.org/InStock" />
      </div>

      <div class="rating" aria-label={`Rated ${rating} out of 5 by ${rating_count} students`}>
        <span class="stars" aria-hidden="true">
          {'★★★★★'.slice(0, Math.round(rating))}{'☆☆☆☆☆'.slice(0, 5 - Math.round(rating))}
        </span>
        <small>{rating} ({rating_count})</small>
      </div>
    </div>

    <div class="cta-row">
      {slug && <a class="btn ghost" href={detailsHref}>Details</a>}
      <a class="btn primary" href={buy_url} rel="nofollow">Buy</a>
    </div>

    <div class="comm">
      <span class="pill">{commission_pct}% commission</span>
    </div>
  </div>

  <!-- Product JSON-LD -->
  <script type="application/ld+json">
    {JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Product',
      name: title,
      description: blurb,
      image: image_url,
      offers: {
        '@type': 'Offer',
        priceCurrency: 'USD',
        price,
        availability: 'https://schema.org/InStock',
      },
      aggregateRating: {
        '@type': 'AggregateRating',
        ratingValue: rating,
        reviewCount: rating_count,
      }
    })}
  </script>

  <style>
    .card {
      display: grid; grid-template-rows: auto 1fr; gap: .75rem;
      background: #0e1a2b; border: 1px solid #1f2b3e; border-radius: 16px; overflow: hidden;
      box-shadow: 0 2px 14px rgba(0,0,0,.2);
    }
    .thumb { position: relative; display: block; aspect-ratio: 16/9; overflow: hidden; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .badge { position: absolute; top: .5rem; left: .5rem; background:#5BE1C5; color:#0e1a2b; font-weight:700; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; }
    .card-body { padding: 1rem 1rem 1.25rem; }
    .title { margin: .25rem 0 .25rem; font-size: 1.05rem; line-height:1.3; }
    .blurb { color:#c7cfdd; font-size:.9rem; min-height: 3.2em; }
    .meta { display:flex; justify-content:space-between; align-items:center; margin:.5rem 0 .75rem; }
    .price strong { font-size:1.05rem; }
    .rating .stars { letter-spacing:.15ch; }
    .cta-row { display:flex; gap:.5rem; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:.6rem .85rem; border-radius:10px; text-decoration:none; font-weight:600; }
    .btn.primary { background:#5BE1C5; color:#0e1a2b; }
    .btn.ghost { border:1px solid #3B4758; color:#e9eef5; }
    .pill { font-size:.75rem; color:#a9b6c7; border:1px dashed #3B4758; padding:.15rem .45rem; border-radius:999px; }
  </style>
</article>
